# JavaScript

## Общие положения

JavaScript-код пишется с использованием последних возможностей языка из спецификаций **ES6+**.

Для AJAX-запросов используем **fetch**.

## Библиотеки и фреймворки

Используется фреймворк Vue и Vuex.

*На проекте не используется библиотека jQuery*.

## Файловая структура и архитектура

Весь JavaScript-код находятся в папках `scripts/` и `components/`.

`scripts/index.js` -- точка входа для сборки, содержит импорты других модулей.

`scripts/breakpoints.js` экспортирует массив breakpoint'ов, соответствующий таковым в SCSS переменных. Vue-компоненты и прочие JavaScript-модули, которым нужны значения breakpoint'ов, должны импортировать этот массив и брать значения только из него (за исключением случаев, когда нужен специфический размер экрана без привязки к breakpoint'ам -- встречается очень редко).

`scripts/components.js` содержит импорт и глобальное объявление всех Vue-компонентов.

`scripts/libs/` содержит библиотеки, которые по какой-то причине нельзя подключить с помощью npm (yarn).

`scripts/model/model.js` содержит хранилище Vuex. Хранилище состоит из модулей, которые находятся в подпапке `scripts/model/modules/` и отвечают за свой блок функциональности: корзина, избранное, сравнение, геолокация, данные пользователя и т. д.

`scripts/view/view.js` импортирует модули, отвечающие за какую-либо JavaScript-функциональность, не привязанную к конкретным Vue-компонентам или хранилищу данных. Модули находятся в подпапке `scripts/view/modules`.

`scripts/controller/controller.js` экспортирует объект, отвечающий за управление состоянием приложения (открытие/закрытие модальных окон, меню и т. д.).

### Vue

#### Компоненты

Все Vue-компоненты находятся в `components/` в виде однофайловых компонентов (`.vue`).

Название файла совпадает с названием компонента.

Все названия компонентов пишутся в `kebab-case` с префиксом `v-`. Это позволяет без труда следовать рекомендации из документации Vue, которая говорит, что названия компонентов должны содержать как минимум один дефис, для избежания коллизий с названиями будущих html-тегов. Теоретически большинство компонентов могут использоваться как в коде html-страницы, так и внутри других компонентов. В этом случае документация Vue также рекомендует везде использовать `kebab-case`.

На корневом теге каждого компонента должен присутствовать класс с названием компонента, причем этот класс должен быть первым. Это позволяет видеть, к какому компоненту относится код, просматривая html-структуру страницы в инструментах разработчика.

Маленькие вспомогательные компоненты находятся в дикеркории `components/helpers/`. Четкие критерии того, какие компоненты относятся к ним, а какие нет, не определены.

#### Миксины

Vue-миксины находятся в `components/mixins/`.

##### v-mixin-formatting

Миксин содержит набор методов для форматирования значений (чисел, цен, дат) и метод `pluralize` для динамического выбора окончаний слов в зависимости от числа.

`pluralize(value, wordBase, wordEndings, approx)`

Метод принимает 4 аргумента:

* `value` -- число, влияющее на окончание слова.
* `wordBase` -- базовая неизменная часть слова.
* `wordEndings` -- массив окончаний слова, состоящий из трех элементов: `wordEndings[0]` - 1, `wordEndings[1]` - 2-4, `wordEndings[2]` - 0, 5-9.
* `approx` -- выводить приблизительное значение (с использованием слов "тыс.", "млн.").

##### v-mixin-source

Миксин `v-mixin-source` содержит код для загрузки/обновления данных.

Миксин добавляет два метода: `dataLoad` и `dataSet`, два `props`: `dataSource` и `bxajaxid`, и два свойства в блок `data`: `loading` и `localBxajaxid`.

Также в `created` компонента проверяется наличие слотов с компонентами `v-source` и атрибуты `data-source` и `bxajaxid` самого компонента для получения начальных данных.

Если тип значения начальных данных -- `string`, значение принимается в качестве ссылки и по ней осуществляется первый AJAX-запрос (вызывается метод `dataLoad`). Иначе данные берутся напрямую из атрибута.

Для загрузки данных предназначен метод `dataLoad`.

`async dataLoad(options = {}, dataSetOptions)`

Метод принимает два аргумента:

* `options` -- объект с данными для запроса.
	* `options.url` -- адрес для запроса.
	* `options.data` -- данные, передаваемые в запросе.
	* `options.delay` -- не завершать запрос быстрее 250мс, в основном используется для того, чтобы анимация показа прелоадера успела красиво отработать при быстром соединении.
* `dataSetOptions` -- дополнительные параметры для передачи в `dataSet` после завершения загрузки. Значение по умолчанию: `undefined`.

После получения данных вызывается метод `dataSet`, которому передаются эти данные. Каждый компонент должен переопределить этот метод для себя, иначе просто будет выведен warning.

`dataSet(data, options)`

Метод принимает два аргумента:

* `data` -- загруженные данные.
* `options` -- дополнительные параметры, переданные при вызове метода `dataLoad`. Значение по умолчанию: `undefined`.